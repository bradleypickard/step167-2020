<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melting Pot</title>
    <link rel="stylesheet" href="style.css" />
    <script type="module" src="/scripts/init.js"></script>
    <!-- Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <div id="recipe"></div>
    <!-- Comment submission form -->
    <div>
      <label for="comment-content" id="comment-label">Message</label><br />
      <input type="text" id="comment-content" name="comment-content" placeholder="Leave a comment..." />
      <br />
      <button type="button" id="submit-comment" value="Submit">Submit</button>
    </div>
    <div id="comments"></div>
    <button type="button" id="save-post">Save this recipe</button>
    <p id="saved"></p>
    <div id="votes">
      Votes:
    </div>
    <button type="button" id="upvote">Toggle Upvote</button>
    <button type="button" id="downvote">Toggle Downvote</button>

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>

    <!-- Page scripts -->
    <script type="module">
      import { app } from "/scripts/init.js"

      var savePostButton = document.getElementById("save-post")
      var submitCommButton = document.getElementById("submit-comment")
      var commentLabel = document.getElementById("comment-label")
      var commentContent = document.getElementById("comment-content")
      var isSavedText = document.getElementById("saved")
      var editForm = document.createElement("input")
      var cancelEdit = document.createElement("button")
      var submitEdit = document.createElement("button")
      var votesDiv = document.getElementById("votes")
      var upvoteButton = document.getElementById("upvote")
      var downvoteButton = document.getElementById("downvote")

      var isSavedRecipe

      var votes = 0
      var voted = 0

      /** On window load, initialize the page. */
      window.onload = function () {
        initPage()
      }

      /** Load page elements. */
      function initPage() {
        // Load the recipe and comments on the page.
        getDetailedRecipe(getRecipeID(), app)
        getComments(getRecipeID())

        //setUpSaveButton()

        savePostButton.addEventListener("click", toggleSave)
        submitCommButton.addEventListener("click", submitComment)
        upvoteButton.addEventListener("click", () => toggleVote(true))
        downvoteButton.addEventListener("click", () => toggleVote(false))

        //toggleElementVisibility(app.auth().currentUser)

        // Set Firebase auth state change listener.
        app.auth().onAuthStateChanged(function (user) {
          toggleElementVisibility(user)
          setUpSaveButton(user)
          getUserRecipeProperties(getRecipeID())
        })
      }

      /** Toggle buttons' & other elements' visibility. */
      function toggleElementVisibility(isVisible) {
        var elements = [savePostButton, submitCommButton, commentLabel, commentContent]
        for (var el of elements) {
          el.hidden = !isVisible
        }
      }

      /** Initial retrieval of boolean from back end inidicating whether the user has saved this recipe. */
      function setUpSaveButton(currentUser) {
        if (currentUser) {
          currentUser
            .getIdToken(/* forceRefresh */ true)
            .then((idToken) => {
              fetch("/api/user?token=" + idToken + "&recipeID=" + getRecipeID() + "&type=SAVE")
                .then((response) => response.text())
                .then((boolArray) => JSON.parse(boolArray))
                .then((isSaved) => {
                  isSavedRecipe = isSaved[0]
                  if (isSavedRecipe) {
                    isSavedText.textContent = "Saved!"
                    savePostButton.textContent = "Unsave this recipe"
                  } else {
                    isSavedText.textContent = ""
                    savePostButton.textContent = "Save this recipe"
                  }
                })
            })
            .catch(function (error) {
              alert(error.message)
            })
        }
      }

      function getUserRecipeProperties(ID) {
        if (app.auth().currentUser) {
          app
            .auth()
            .currentUser.getIdToken(/* forceRefresh */ true)
            .then((idToken) =>
              fetch("api/vote?recipeIds=" + ID + "&token=" + idToken)
                .then((res) => res.json())
                .then((data) => {
                  if (data[0] === true) {
                    voted = 1
                  } else if (data[0] === null) {
                    voted = 0
                  } else if (data[0] === false) {
                    voted = -1
                  }
                })
            )
        }
      }

      /** Returns the recipe ID in the query string for this page. */
      function getRecipeID() {
        const params = new URLSearchParams(window.location.search)
        return params.get("recipeID")
      }

      /** Let a signed-in user save or unsave a recipe. */
      function toggleSave() {
        var recipeID = getRecipeID()

        if (app.auth().currentUser) {
          app
            .auth()
            .currentUser.getIdToken(/* forceRefresh */ true)
            .then(function (idToken) {
              // Toggle the is-saved value.
              isSavedRecipe = !isSavedRecipe

              var urlStringPart
              var alertTextValue
              var buttonTextValue
              var saveTextValue

              // If the NEW value indicates saved, then save the recipe.
              if (isSavedRecipe) {
                urlStringPart = "SAVE"
                alertTextValue = " saved!"
                buttonTextValue = "Unsave this recipe"
                saveTextValue = "Saved"
              } else {
                urlStringPart = "UNSAVE"
                alertTextValue = " unsaved!"
                buttonTextValue = "Save this recipe"
                saveTextValue = ""
              }

              fetch("/api/user?recipeID=" + recipeID + "&token=" + idToken + "&type=" + urlStringPart, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
              }).then((response) => {
                if (response.ok) {
                  alert("Recipe" + alertTextValue)
                } else {
                  alert("Error " + response.status.toString())
                }
              })
              isSavedText.textContent = saveTextValue
              savePostButton.textContent = buttonTextValue
            })
            .catch(function (error) {
              alert("Error! Could not retrieve user ID token.")
            })
        } else {
          alert("User must be signed in to save a post.")
        }
      }

      /** Submit a comment -- disallow if no user is signed into the webapp. */
      function submitComment() {
        var commentContent = document.getElementById("comment-content")
        var recipeID = getRecipeID()
        if (app.auth().currentUser) {
          app
            .auth()
            .currentUser.getIdToken(/* forceRefresh */ true)
            .then(function (idToken) {
              fetch("/api/comment?recipeID=" + recipeID + "&token=" + idToken, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  content: commentContent.value,
                }),
              }).then((response) => {
                if (response.ok) {
                  getComments(recipeID)
                } else {
                  alert("Error " + response.status.toString())
                }
              })
            })
            .catch(function (error) {
              alert("Error! Could not retrieve user ID token.")
            })
        } else {
          alert("User must be signed in to submit a comment.")
        }
      }

      /** Adds comments associated with a recipe to the UI. */
      function getComments(recipeID) {
        fetch("api/comment?recipeID=" + recipeID)
          .then(() => fetch("api/comment?recipeID=" + recipeID))
          .then((response) => response.json())
          .then((comments) => {
            const commentsEl = document.getElementById("comments")
            commentsEl.innerHTML = ""
            comments.forEach((comment) => {
              commentsEl.appendChild(createCommentElement(comment))
            })
          })
      }

      function getDetailedRecipe(ID, app) {
        fetch("/api/post?recipeID=" + ID)
          .then((response) => response.json())
          .then((recipe) => {
            const recipeEl = document.getElementById("recipe")
            votes = recipe.metadata.votes
            votesDiv.innerHTML = "Votes: " + recipe.metadata.votes
            removeAllChildNodes(recipeEl)
            recipeEl.appendChild(createRecipeElement(recipe))
          })
      }

      /* Deletes the currently displayed post and all associated comments.
       *   TODO: Only allow this operation to be taken by post creator
       */
      function deletePost() {
        var recipeID = getRecipeID()

        if (app.auth().currentUser) {
          app
            .auth()
            .currentUser.getIdToken(/* forceRefresh */ true)
            .then(function (idToken) {
              fetch("/api/post?recipeID=" + recipeID + "&token=" + idToken, {
                method: "DELETE",
              }).then((response) => {
                if (response.ok) {
                  window.location.href = "/feed.html"
                } else {
                  alert("Error " + response.status.toString())
                }
              })
            })
            .catch(function (error) {
              alert("Error! Could not retrieve user ID token.")
            })
        } else {
          alert("User must be signed in to submit a comment.")
        }
      }

      /* Event triggered by clicking on an Edit button.
       * Adds form to the comment for user to specify edits
       */
      function editComment(commentEl) {
        commentEl.removeChild(commentEl.querySelector("hr"))
        commentEl.appendChild(editForm)
        commentEl.appendChild(submitEdit)
        commentEl.appendChild(cancelEdit)
        commentEl.appendChild(document.createElement("hr"))

        editForm.value = commentEl.querySelector("p").innerText
        submitEdit.innerText = "Submit"
        cancelEdit.innerText = "Cancel"

        submitEdit.addEventListener("click", submitEditEvent)
        cancelEdit.addEventListener("click", endEditEvent)
      }

      /* Event triggered by clicking Submit Button under Edit
       * Removes edit form, calls function to upload changes to DB
       */
      function submitEditEvent(e) {
        const parent = submitEdit.parentNode
        endEditEvent()
        submitCommentEdit(getRecipeID(), parent, editForm.value)
      }

      /* Event triggered by clicking Submit Button under Edit
       * Removes edit form, calls function to upload changes to DB
       */
      function endEditEvent(e) {
        const parent = submitEdit.parentNode
        parent.removeChild(editForm)
        parent.removeChild(submitEdit)
        parent.removeChild(cancelEdit)
        submitEdit.removeEventListener("click", submitEditEvent)
        cancelEdit.removeEventListener("click", endEditEvent)
      }

      /* Uploads comment edits to DB */
      function submitCommentEdit(recipeID, commentEl, newBody) {
        const bodyElement = commentEl.querySelector("p")
        if (app.auth().currentUser) {
          app
            .auth()
            .currentUser.getIdToken(/* forceRefresh */ true)
            .then(function (idToken) {
              fetch(
                "/api/comment?recipeID=" +
                  recipeID +
                  "&commentID=" +
                  commentEl.id +
                  "&commentBody=" +
                  newBody +
                  "&token=" +
                  idToken,
                {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                  },
                }
              ).then((response) => {
                if (!response.ok) {
                  alert("Error " + response.status.toString())
                } else {
                  getComments(recipeID)
                }
              })
            })
            .catch(function (error) {
              alert("Error! Could not retrieve user ID token.")
            })
        } else {
          alert("User must be signed in to submit a comment.")
        }
      }

      function toggleVote(vote) {
        var recipeID = getRecipeID()

        if (app.auth().currentUser) {
          if (voted === 1) {
            if (vote) {
              voted = 0
              votes += -1
            } else {
              voted = -1
              votes += -2
            }
          } else if (voted === 0) {
            if (vote) {
              voted = 1
              votes += 1
            } else {
              voted = -1
              votes += -1
            }
          } else if (voted == -1) {
            if (vote) {
              voted = 1
              votes += 2
            } else {
              voted = 0
              votes += 1
            }
          }
          votesDiv.innerHTML = "Votes: " + votes
          firebase
            .auth()
            .currentUser.getIdToken(/* forceRefresh */ true)
            .then((idToken) => {
              fetch("/api/vote?recipeId=" + recipeID + "&vote=" + vote + "&token=" + idToken, {
                method: "PUT",
              }).then((response) => {
                if (response.ok) {
                  return response.json()
                } else {
                  alert("Error " + response.status.toString())
                }
              })
            })
            .catch(function (error) {
              alert("Error! Could not retrieve user ID token.")
            })
        } else {
          alert("User must be signed in to vote.")
        }
      }

      function removeAllChildNodes(parent) {
        while (parent.firstChild) {
          parent.removeChild(parent.firstChild)
        }
      }

      /* Constructs a comment element containing content, an edit button, and a thematic break
       *   NOTE: Only create edit button if comment's creator ID = current User ID
       */
      function createCommentElement(comment) {
        const commentEl = document.createElement("div")
        commentEl.id = comment.id
        commentEl.appendChild(createBasicElement(comment.content, "p"))
        if (app.auth().currentUser && comment.creatorId == app.auth().currentUser.uid) {
          const editBtn = document.createElement("button")
          editBtn.type = "button"
          commentEl.appendChild(editBtn)
          editBtn.innerText = "Edit"
          editBtn.addEventListener("click", function (e) {
            editComment(editBtn.parentNode)
          })
        }
        commentEl.appendChild(document.createElement("hr"))
        return commentEl
      }

      function createRecipeElement(recipe) {
        const recipeElement = document.createElement("div")
        recipeElement.appendChild(createBasicElement(recipe.metadata.title, "h2"))
        recipeElement.appendChild(createBasicElement(recipe.content, "p"))
        if (app.auth().currentUser && recipe.metadata.creatorId == app.auth().currentUser.uid) {
          const deleteBtn = document.createElement("button")
          deleteBtn.type = "button"
          recipeElement.appendChild(deleteBtn)
          deleteBtn.innerText = "Delete Recipe"
          deleteBtn.addEventListener("click", deletePost)
        }
        return recipeElement
      }

      function createBasicElement(text, type) {
        const basicElement = document.createElement(type)
        if (text != "") basicElement.innerHTML = marked(text)
        return basicElement
      }
    </script>
  </body>
</html>
