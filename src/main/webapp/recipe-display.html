<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melting Pot</title>
    <link rel="stylesheet" href="style.css" />
    <!-- Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body onload="getDetailedRecipe(getRecipeID()); getComments(getRecipeID())">
    <div id="recipe"></div>
    <!-- Comment submission form -->
    <div>
      <label for="comment-content">Message</label><br />
      <input type="text" id="comment-content" name="comment-content" placeholder="Leave a comment..." />
      <br />
      <button type="button" onclick="submitComment(getRecipeID())" value="Submit">Submit</button>
    </div>
    <div id="comments"></div>
    <button type="button" onclick="deletePost(getRecipeID())">Delete Post</button>

    <!-- Page scripts -->
    <script>
      let editForm = document.createElement("input")
      let submitEdit = document.createElement("button")

      /** Returns the recipe ID in the query string for this page. */
      function getRecipeID() {
        const params = new URLSearchParams(window.location.search)
        return params.get("recipeID")
      }

      function submitComment(recipeID) {
        var commentContent = document.getElementById("comment-content")
        console.log(recipeID)
        fetch("/api/comment?recipeID=" + recipeID, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            content: commentContent.value,
          }),
        }).then((response) => {
          if (response.status === 202) {
            getComments(recipeID)
          } else {
            alert("Error " + response.status.toString())
          }
        })
      }

      /** Adds comments associated with a recipe to the UI. */
      function getComments(recipeID) {
        fetch("api/comment?recipeID=" + recipeID)
          .then(() => fetch("api/comment?recipeID=" + recipeID))
          .then((response) => response.json())
          .then((comments) => {
            const commentsEl = document.getElementById("comments")
            commentsEl.innerHTML = ""
            comments.forEach((comment) => {
              commentsEl.appendChild(createCommentElement(comment))
            })
          })
      }

      function getDetailedRecipe(ID) {
        fetch("/api/post?recipeID=" + ID)
          .then((response) => response.json())
          .then((recipe) => {
            const recipeEl = document.getElementById("recipe")
            removeAllChildNodes(recipeEl)
            recipeEl.appendChild(createRecipeListElement(recipe))
          })
      }
      /* Deletes the currently displayed post and all associated comments.
       *   TODO: Only allow this operation to be taken by post creator
       */
      function deletePost(recipeID) {
        fetch("/api/post?recipeID=" + recipeID, {
          method: "DELETE",
        }).then((response) => {
          if (response.status === 200) {
            window.location.href = "/feed.html"
          } else {
            alert("Error " + response.status.toString())
          }
        })
      }

      /* Event triggered by clicking on an Edit button.
       * Adds form to the comment for user to specify edits
       */
      function editComment(commentEl) {
        commentEl.removeChild(commentEl.querySelector("hr"))
        commentEl.appendChild(editForm)
        commentEl.appendChild(submitEdit)
        commentEl.appendChild(document.createElement("hr"))

        editForm.value = commentEl.querySelector("p").innerText
        submitEdit.innerText = "Submit"
        submitEdit.addEventListener("click", submitEditEvent)
      }

      /* Event triggered by clicking Submit Button under Edit
       * Removes edit form, calls function to upload changes to DB
       */
      function submitEditEvent(e) {
        const parent = submitEdit.parentNode
        parent.removeChild(editForm)
        parent.removeChild(submitEdit)
        submitEdit.removeEventListener("click", submitEditEvent)
        submitCommentEdit(getRecipeID(), parent, editForm.value)
      }

      /* Uploads comment edits to DB */
      function submitCommentEdit(recipeID, commentEl, newBody) {
        const bodyElement = commentEl.querySelector("p")
        console.log(commentEl.id)
        fetch("/api/comment?recipeID=" + recipeID + "&commentID=" + commentEl.id + "&commentBody=" + newBody, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
        }).then((response) => {
          if (response.status < 200 || response.status >= 300) {
            alert("Error " + response.status.toString())
          } else {
            getComments(recipeID)
          }
        })
      }

      function removeAllChildNodes(parent) {
        while (parent.firstChild) {
          parent.removeChild(parent.firstChild)
        }
      }

      /* Constructs a comment element containing content, an edit button, and a thematic break
       *   TODO: Only create edit button if comment's creator ID = current User ID
       */
      function createCommentElement(comment) {
        const commentEl = document.createElement("div")
        commentEl.id = comment.id
        commentEl.appendChild(createBasicElement(comment.content, "p"))
        const editBtn = document.createElement("button")
        editBtn.type = "button"
        commentEl.appendChild(editBtn)
        editBtn.innerText = "Edit"
        editBtn.addEventListener("click", function (e) {
          editComment(editBtn.parentNode)
        })
        commentEl.appendChild(document.createElement("hr"))
        return commentEl
      }

      function createRecipeListElement(recipe) {
        const recipeElement = document.createElement("div")
        recipeElement.appendChild(createBasicElement(recipe.title, "h2"))
        recipeElement.appendChild(createBasicElement(recipe.content, "p"))
        return recipeElement
      }

      function createBasicElement(text, type) {
        const basicElement = document.createElement(type)
        if (text != "") basicElement.innerHTML = marked(text)
        return basicElement
      }
    </script>
  </body>
</html>
