<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Melting Pot</title>
    <link rel="stylesheet" href="style.css" />
    <script type="module" src="/scripts/init.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <!-- Recipe form -->
    <div id="recipe-form">
      <!--  action="/api/post" method="POST" enctype="multipart/form-data" -->
      <label for="recipe-title">Recipe Title</label><br />
      <input type="text" id="recipe-title" name="title" placeholder="e.g. Grandma's Zucchini Florentine" />
      <br />
      <label for="instructions">Recipe Instructions</label><br />
      <textarea
        rows="10"
        cols="70"
        name="content"
        id="instructions"
        placeholder="e.g. Preheat the oven to 350 degrees."
      ></textarea>
      <br />
      <p>Add tags to your recipe:</p>
      <select id="tag-select">
        <option>None</option>
      </select>
      <p>Currently selected tags:</p>
      <div id="selected-tags" name="tagIds" value="getCurrentTagsAsList()"></div>
      <br />
      <p>Upload an image with your recipe:</p>
      <br />
      <input type="file" name="image" id="image" /> <br />
      <button type="button" id="submit" value="Submit">Submit</button>
    </div>
    <div id="recipe-preview">
      <h1 id="title-preview"></h1>
      <div id="instructions-preview"></div>
    </div>
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-app.js"></script>

    <!-- If you enabled Analytics in your project, add the Firebase SDK for Analytics -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-analytics.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/7.16.1/firebase-auth.js"></script>

    <script type="module">
      import { app } from "/scripts/init.js"

      var tagSelect = document.getElementById("tag-select")
      var imageInput = document.getElementById("image")

      /** On window load, initialize the page. */
      window.onload = function () {
        initPage()
      }

      /** Load page elements. */
      function initPage() {
        // Set event listeners.
        document.getElementById("submit").addEventListener("click", submitRecipe)
        document.querySelector("input").addEventListener("input", renderRecipe)
        document.querySelector("textarea").addEventListener("input", renderRecipe)
        tagSelect.addEventListener("change", addTag)
        imageInput.addEventListener("change", validateImage)

        // Initialize tag-select
        loadTags()
      }

      // Fetch all recipe tags to populate our select form
      function loadTags() {
        fetch("/api/tag").then(async (response) => {
          if (!response.ok) {
            alert("Error " + response.status.toString())
          } else {
            let tags = await response.json()
            tags.forEach((tag) => {
              tagSelect.innerHTML += '<option value="' + tag.id + '">' + tag.name + "</option>"
            })
          }
        })
      }

      /** Resets file input on change if file was not an image. */
      function validateImage() {
        var fileInput = imageInput.files[0]
        var isImage
        // Acceptable image extensions.
        var imgFileExtensions = [".jpg", ".jpeg", ".gif", ".png", ".bmp", ".svg", ".tiff", ".webp"]

        if (imageInput.type == "file") {
          var fileName = fileInput.name
          var fNameLength = fileName.length
          if (fNameLength > 0) {
            isImage = false
            var fileNameLower = fileName.toLowerCase()
            // Loop thru extensions and change boolean to true if the file name equals any of them.
            for (var i = 0; i < imgFileExtensions.length; i++) {
              if (fileNameLower.endsWith(imgFileExtensions[i])) {
                isImage = true
                break
              }
            }
          }
        }
        if (!isImage) {
          alert("Invalid file type. Please submit an image.")
          imageInput.value = ""
        }
        return isImage
      }

      /** Display the recipe being typed in markdown with formatting, in real-time. */
      function renderRecipe() {
        let titleInput = document.getElementById("recipe-title")
        let instructionsInput = document.getElementById("instructions")
        let titlePreview = document.getElementById("title-preview")
        let instructionsPreview = document.getElementById("instructions-preview")

        titlePreview.innerText = titleInput.value
        instructionsPreview.innerHTML = marked(instructions.value)
      }

      /** Submit a recipe-- disallow if no user is signed into webapp. */
      function submitRecipe() {
        let titleInput = document.getElementById("recipe-title")
        let instructionsInput = document.getElementById("instructions")
        let tags = getCurrentTagsAsList()
        var userToken

        // Make sure a user is signed in before posting.
        if (app.auth().currentUser) {
          app
            .auth()
            .currentUser.getIdToken(/* forceRefresh */ true)
            .then(function (idToken) {
                userToken = idToken
              fetch("/blobstore-upload?token=" + idToken)
                .then((promise) => {
                  if (!promise.ok) {
                    alert("Unauthorized.")
                    return
                  } else {
                    return promise.text()
                  }
                })
                .then((blobstoreUploadURL) => {
                  console.log(blobstoreUploadURL)

                  const form = document.createElement("form")
                  form.method = "POST"
                  form.action = blobstoreUploadURL
                  form.enctype = "multipart/form-data"
                  const params = {
                    title: titleInput.value,
                    content: instructionsInput.value,
                    tagIds: tags.toString(),
                    image: imageInput.files[0],
                    token: userToken 
                  }

                  for (const key in params) {
                    const recipeField = document.createElement("input")
                    recipeField.type = "hidden"
                    recipeField.name = key
                    recipeField.value = params[key]

                    form.appendChild(recipeField)
                  }

                  document.body.appendChild(form)
                  form.submit()
                  .then((response) => {
                    if (!response.ok) {
                      alert("Error " + response.status.toString())
                      return
                    }
                    response.json().then((data) => (window.location.href = "/recipe-display.html?recipeID=" + data.id))
                  })
                })
            })
            .catch(function (error) {
              alert("Error! Could not retrieve user ID token.")
            })
        } else {
          alert("User must be signed in to submit a recipe.")
        }
      }
      /*.then((response) => {
                    if (!response.ok) {
                      alert("Error " + response.status.toString())
                      return
                    }
                    response.json().then((data) => (window.location.href = "/recipe-display.html?recipeID=" + data.id))
                  })
                })*/

      // Returns the current set of tags as a List
      function getCurrentTagsAsList() {
        return Array.from(document.getElementById("selected-tags").childNodes)
      }

      // Adds a tag to list of selected-tags
      function addTag() {
        const tagID = tagSelect.value
        if (tagID == "None" || tagSelected(tagID)) {
          return
        }
        let tagList = document.getElementById("selected-tags")

        // Create 'tag' element with id matching tag ID and innertext matching tag name
        const tag = document.createElement("DIV")
        // Retrieve option with matching tagID then retrieve innertext (tag name)
        tag.innerText = getOptionByValue(tagID).innerText
        tag.id = tagID

        tagList.appendChild(tag)
        tag.addEventListener("click", function (e) {
          // When we click a currently selected tag, remove it and retrieve recipes
          tag.parentNode.removeChild(tag)
        })
      }

      // Determines if the passed tagID is represented in the current selected tags
      function tagSelected(tagID) {
        var selectedTags = document.getElementById("selected-tags").childNodes
        for (var x = 0; x < selectedTags.length; x++) {
          if (selectedTags[x].id == tagID) return true
        }
        return false
      }

      // Returns the first option whose 'value' property (ie the id of the tag it represents)
      // matches value
      function getOptionByValue(value) {
        var allOptions = document.getElementsByTagName("option")
        var results = []
        for (var x = 0; x < allOptions.length; x++) {
          if (allOptions[x].value == value) {
            results.push(allOptions[x])
          }
        }
        return results[0]
      }
    </script>
  </body>
</html>
